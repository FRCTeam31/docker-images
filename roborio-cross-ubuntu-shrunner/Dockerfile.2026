FROM ubuntu:24.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y apt-transport-https \
    ca-certificates \
    gnupg \
    software-properties-common \
    wget && \
    wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null && \
    echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ noble main' > /etc/apt/sources.list.d/kitware.list && \
    add-apt-repository ppa:git-core/ppa && \
    apt-get update && apt-get install -y tzdata && apt-get install -y \
    build-essential \
    ca-certificates \
    clang-format-14 \
    cmake \
    curl \
    fakeroot \
    g++ --no-install-recommends \
    gcc \
    gdb \
    gfortran \
    git \
    java-common \
    libc6-dev \
    libgl1-mesa-dev \
    libglu1-mesa-dev \
    libisl-dev \
    libopencv-dev \
    libopencv-java \
    libvulkan-dev \
    libx11-dev \
    libxcursor-dev \
    libxi-dev \
    libxinerama-dev \
    libxrandr-dev \
    make \
    mesa-common-dev \
    openjdk-17-jdk \
    python3-dev \
    python3-pip \
    python3-setuptools \
    sudo \
    unzip \
    wget \
    zip \
  && rm -rf /var/lib/apt/lists/*

ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64

# Create a non-root user for the runner
RUN useradd -m -s /bin/bash runner && \
    echo "runner ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to runner user
USER runner
WORKDIR /home/runner

# Download and install WPILib 2026
RUN wget -q https://packages.wpilib.workers.dev/installer/v2026.1.1/Linux/WPILib_Linux-2026.1.1.tar.gz && \
    mkdir -p /home/runner/wpilib/2026 && \
    tar -xzf WPILib_Linux-2026.1.1.tar.gz -C /home/runner && \
    rm WPILib_Linux-2026.1.1.tar.gz

# Set up environment variables for WPILib
ENV WPILIB_HOME=/home/runner/wpilib/2026
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Verify Java installation
RUN java -version

# Download and set up GitHub Actions runner
RUN mkdir actions-runner && cd actions-runner && \
    curl -o actions-runner-linux-x64-2.330.0.tar.gz -L https://github.com/actions/runner/releases/download/v2.330.0/actions-runner-linux-x64-2.330.0.tar.gz && \
    tar xzf actions-runner-linux-x64-2.330.0.tar.gz && \
    rm actions-runner-linux-x64-2.330.0.tar.gz

WORKDIR /home/runner/actions-runner

# Create startup script with .env file generation
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# Create .env file for the runner to pass variables to jobs\n\
cat > /home/runner/actions-runner/.env << "EOF"\n\
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64\n\
WPILIB_HOME=/home/runner/wpilib/2026\n\
PATH=/usr/lib/jvm/java-17-openjdk-amd64/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n\
EOF\n\
\n\
echo "Created .env file with JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"\n\
\n\
if [ -z "$RUNNER_TOKEN" ] || [ -z "$RUNNER_URL" ]; then\n\
    echo "Error: RUNNER_TOKEN and RUNNER_URL environment variables must be set"\n\
    exit 1\n\
fi\n\
\n\
# Remove old configuration if it exists\n\
if [ -f ".runner" ]; then\n\
    echo "Removing old runner configuration..."\n\
    ./config.sh remove --token "$RUNNER_TOKEN" || true\n\
    rm -f .runner .credentials .credentials_rsaparams\n\
fi\n\
\n\
# Configure the runner with retry logic\n\
echo "Configuring GitHub Actions runner..."\n\
MAX_RETRIES=5\n\
RETRY_COUNT=0\n\
\n\
while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do\n\
    if ./config.sh --url "$RUNNER_URL" --token "$RUNNER_TOKEN" --name "${RUNNER_NAME:-roborio-runner-2026}" --work _work --labels "${RUNNER_LABELS:-roborio,wpilib,2026}" --unattended --replace; then\n\
        echo "Runner configured successfully!"\n\
        break\n\
    else\n\
        RETRY_COUNT=$((RETRY_COUNT + 1))\n\
        if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then\n\
            echo "Configuration failed. Retrying in 10 seconds... (Attempt $RETRY_COUNT/$MAX_RETRIES)"\n\
            sleep 10\n\
        else\n\
            echo "Failed to configure runner after $MAX_RETRIES attempts."\n\
            echo "Please check:"\n\
            echo "  1. Your RUNNER_TOKEN is valid (tokens expire after 1 hour)"\n\
            echo "  2. Your RUNNER_URL is correct"\n\
            echo "  3. Your network connection to GitHub is working"\n\
            exit 1\n\
        fi\n\
    fi\n\
done\n\
\n\
# Start the runner\n\
echo "Starting GitHub Actions runner..."\n\
echo "JAVA_HOME is set to: /usr/lib/jvm/java-17-openjdk-amd64"\n\
./run.sh' > /home/runner/actions-runner/start.sh && \
    chmod +x /home/runner/actions-runner/start.sh

CMD ["/home/runner/actions-runner/start.sh"]
